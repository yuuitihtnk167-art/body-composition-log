<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0f766e" />
  <title>BodyLog（体組成ログ）</title>

  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">B</div>
      <div>
        <div class="title">BodyLog</div>
        <div class="subtitle">体組成ログ（端末内保存・オフライン対応）</div>
      </div>
    </div>
    <button id="installBtn" class="btn ghost" hidden>インストール</button>
  </header>

  <main class="container">
    <section class="card">
      <h2>ダッシュボード</h2>
      <div class="grid2">
        <div class="kpi">
          <div class="kpiLabel">最新日付</div>
          <div id="kpiDate" class="kpiValue">-</div>
        </div>
        <div class="kpi">
          <div class="kpiLabel">直近7日 平均体重</div>
          <div id="kpiW7" class="kpiValue">-</div>
        </div>
      </div>
      <p id="dashNote" class="note"></p>
    </section>

    <section class="card">
      <h2>今日の入力</h2>
      <form id="entryForm" class="form">
        <div class="row">
          <label>日付</label>
          <input type="date" id="fDate" required />
        </div>

        <div class="row">
          <label>体重 (kg)</label>
          <div class="withStepper">
            <button type="button" class="step" data-id="fWeight" data-delta="-0.1">−</button>
            <input inputmode="decimal" id="fWeight" placeholder="例: 55.0" />
            <button type="button" class="step" data-id="fWeight" data-delta="0.1">＋</button>
          </div>
          <div id="hintWeight" class="hint"></div>
        </div>

        <div class="row">
          <label>BMI</label>
          <input inputmode="decimal" id="fBmi" placeholder="例: 19.8" />
          <div id="hintBmi" class="hint"></div>
        </div>

        <div class="row">
          <label>体脂肪率 (%)</label>
          <div class="withStepper">
            <button type="button" class="step" data-id="fFat" data-delta="-0.1">−</button>
            <input inputmode="decimal" id="fFat" placeholder="例: 16.5" />
            <button type="button" class="step" data-id="fFat" data-delta="0.1">＋</button>
          </div>
          <div id="hintFat" class="hint"></div>
        </div>

        <div class="row">
          <label>筋肉量 (kg)</label>
          <div class="withStepper">
            <button type="button" class="step" data-id="fMuscle" data-delta="-0.1">−</button>
            <input inputmode="decimal" id="fMuscle" placeholder="例: 43.5" />
            <button type="button" class="step" data-id="fMuscle" data-delta="0.1">＋</button>
          </div>
          <div id="hintMuscle" class="hint"></div>
        </div>

        <div class="row">
          <label>内臓脂肪</label>
          <input inputmode="decimal" id="fVisceral" placeholder="例: 8.5" />
          <div id="hintVisceral" class="hint"></div>
        </div>

        <div class="row">
          <label>基礎代謝量 (kcal)</label>
          <input inputmode="numeric" id="fBmr" placeholder="例: 1230" />
          <div id="hintBmr" class="hint"></div>
        </div>

        <div class="row">
          <label>体内年齢</label>
          <input inputmode="numeric" id="fAge" placeholder="例: 44" />
          <div id="hintAge" class="hint"></div>
        </div>

        <div class="row">
          <label>メモ（任意）</label>
          <textarea id="fMemo" rows="2" placeholder="例: 運動/睡眠/食事など"></textarea>
        </div>

        <div class="actions">
          <button class="btn" type="submit">保存</button>
          <button class="btn danger" type="button" id="deleteBtn" disabled>削除</button>
          <button class="btn ghost" type="button" id="resetBtn">リセット</button>
        </div>
        <p class="small">※医療判断はしません。記録と可視化のみです。</p>
      </form>
    </section>

    <section class="card">
      <h2>インポート / エクスポート</h2>
      <div class="importBox">
        <input type="file" id="csvFile" accept=".csv,text/csv" />
        <div class="importActions">
          <button class="btn" id="importBtn" type="button">CSVインポート</button>
          <button class="btn ghost" id="exportCsvBtn" type="button">CSVエクスポート</button>
        </div>
        <details class="noteBox">
          <summary>CSV形式（対応ヘッダ）</summary>
          <pre>日付,体重,BMI,体脂肪率,筋肉量,内臓脂肪,基礎代謝量,体内年齢</pre>
          <p class="small">日付は YYYY/MM/DD と YYYY-MM-DD を受け付け、内部は YYYY-MM-DD に正規化します。</p>
          <p class="small">Shift-JISのCSVは文字化けすることがあります。可能ならUTF-8で書き出してください。</p>
        </details>
      </div>
      <div id="importResult" class="note"></div>

      <!-- 衝突解決UI（confirm連発しない） -->
      <div id="conflictBox" class="conflictBox hidden">
        <h3>日付が重複しました（衝突解決）</h3>
        <div class="conflictActions">
          <button class="btn" id="applyOverwriteAll" type="button">衝突分を全部上書き</button>
          <button class="btn ghost" id="applySkipAll" type="button">衝突分を全部スキップ</button>
        </div>
        <p class="small">または、日付ごとに「上書き/スキップ」を選んで「選択を適用」できます。</p>
        <div class="tableWrap">
          <table id="conflictTbl">
            <thead>
              <tr>
                <th>日付</th>
                <th>既存 体重</th>
                <th>新規 体重</th>
                <th>選択</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="conflictActions">
          <button class="btn" id="applySelected" type="button">選択を適用</button>
          <button class="btn ghost" id="cancelImport" type="button">キャンセル</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>一覧</h2>
      <div class="toolbar">
        <select id="rangeSel">
          <option value="7">直近7日</option>
          <option value="30" selected>直近30日</option>
          <option value="90">直近90日</option>
          <option value="all">全期間</option>
        </select>
        <button class="btn ghost" id="sortBtn" type="button">日付: 降順</button>
      </div>
      <div class="tableWrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>日付</th>
              <th>体重</th>
              <th>体脂肪率</th>
              <th>筋肉量</th>
              <th>内臓脂肪</th>
              <th>基礎代謝</th>
              <th>体内年齢</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="small">行をタップすると編集できます。</p>
    </section>

   <section class="card">
  <h2>グラフ</h2>
  <div class="toolbar">
    <label class="chk"><input type="checkbox" id="cW" checked>体重</label>
    <label class="chk"><input type="checkbox" id="cF" checked>体脂肪率</label>
    <label class="chk"><input type="checkbox" id="cM" checked>筋肉量</label>
    <label class="chk"><input type="checkbox" id="cMA">7日移動平均</label>
  </div>

  <!-- ★ ここが重要 -->
  <div class="chartWrap">
    <canvas id="chart"></canvas>
  </div>

  <p class="small">Chart.js（CDN）を使用します。</p>
</section>


    <section class="card">
      <h2>ヘルプ</h2>
      <ul class="small">
        <li>データは端末内（IndexedDB）に保存し、外部へ送信しません。</li>
        <li>iPhoneはSafariで開き、共有→「ホーム画面に追加」でインストールします。</li>
        <li>更新が反映されない場合は、ホーム画面のアプリ削除→サイトデータ削除→入れ直しが確実です。</li>
      </ul>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="/app.js"></script>
</body>
</html>

